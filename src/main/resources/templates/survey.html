<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindfulMoment - ADHD 설문조사</title>
    <link rel="stylesheet" th:href="@{/css/common/bootstrap/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/common/common.css}">
    <style>
        body {
            padding-top: 60px;
        }

        .carousel-control-prev, .carousel-control-next {
            width: 10%;
            opacity: 1;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }

        .carousel-control-prev {
            left: -100px;
        }

        .carousel-control-next {
            right: -100px;
        }

        .carousel-control-prev-icon, .carousel-control-next-icon {
            background-color: rgba(0, 123, 255, 0.6);
            border-radius: 50%;
            width: 40px;
            height: 40px;
        }

        .question-row {
            display: flex;
            flex-wrap: wrap;
        }

        .question-col {
            flex: 0 0 50%;
            max-width: 50%;
            padding: 10px;
        }

        .custom-question-card {
            height: 338px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .question-text {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .form-check {
            margin-bottom: 3px;
        }

        .modal-dialog {
            display: flex;
            align-items: center;
            min-height: calc(100% - 1rem);
        }

        @media (max-width: 768px) {
            .question-col {
                flex: 0 0 100%;
                max-width: 100%;
            }

            .custom-question-card {
                height: auto;
                max-height: 325px;
            }
        }

        .modal-footer .btn {
            padding: 10px 20px;
            font-size: 1.5rem;
            min-width: 100px;
        }

        .modal-content {
            font-size: 2rem;
            max-width: 500px;
            background-color: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(5px);
        }

        #warningModal .modal-content {
            background-color: rgba(255, 220, 220, 0.6);
        }

        .modal-header {
            border-bottom: none;
        }

        .modal-footer {
            border-top: none;
        }
    </style>
</head>
<body>
<div th:replace="fragments :: navbar"></div>

<div class="container my-5 position-relative">
    <h1 class="text-center mb-4">자가진단지</h1>
    <div id="questionCarousel" class="carousel slide carousel-fade" data-bs-ride="carousel" data-bs-interval="false">
        <div class="carousel-inner">
            <form id="survey-form">
            </form>
        </div>
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#questionCarousel" data-bs-slide="prev" id="prevButton">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#questionCarousel" data-bs-slide="next" id="nextButton">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
    </button>
    <div class="text-center mt-3">
        <span id="currentPage"></span> / <span id="totalPages"></span>
    </div>
    <p class="disclaimer text-center mt-4">
        본 설문은 참고용으로만 사용되어야 하며, 의학적 진단을 대체할 수 없습니다.
    </p>
</div>

<div class="modal fade" id="submitConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-center fs-4">설문을 제출하시겠습니까?</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-primary btn-lg" id="confirmSubmit">제출</button>
                <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">취소</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="warningModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-center fs-4">답하지 않은 설문 항목이 있습니다. 모든 항목에 답변해 주세요.</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">확인</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">설문 결과</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>당신의 ADHD 위험도 점수는 <span id="adhd-score"></span>점입니다.</p>
                <p id="risk-level"></p>
            </div>
            <div class="modal-footer">
                <a href="/main" class="btn custom-btn-primary">개선하기</a>
            </div>
        </div>
    </div>
</div>

<div th:replace="fragments :: footer"></div>

<script th:src="@{/js/lib/bootstrap.bundle.min.js}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');
        const carouselInner = document.querySelector('.carousel-inner');
        const submitConfirmModal = new bootstrap.Modal(document.getElementById('submitConfirmModal'));
        const warningModal = new bootstrap.Modal(document.getElementById('warningModal'));

        prevButton.style.display = 'none';

        carouselInner.addEventListener('change', function(e) {
            if (e.target.type === 'radio') {
                checkCurrentPageAndNavigate();
            }
        });

        fetch('/api/questions/all')
            .then(response => response.json())
            .then(questions => {
                const carousel = document.querySelector('.carousel-inner');
                const categories = ['ATTENTION', 'HYPERACTIVITY', 'IMPULSIVITY', 'ORGANIZATION'];
                let pageCount = 0;
                let questionNumber = 1;

                categories.forEach((category, categoryIndex) => {
                    const categoryQuestions = questions.filter(q => q.category === category).slice(0, 4);
                    const slide = document.createElement('div');
                    slide.className = `carousel-item ${pageCount === 0 ? 'active' : ''}`;
                    let slideContent = `<div class="question-row">`;
                    categoryQuestions.forEach((question, index) => {
                        slideContent += `
                            <div class="question-col">
                                <div class="custom-question-card">
                                    <p class="question-text"><span class="custom-question-number">Q${questionNumber}.</span> ${question.text}</p>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="q${question.id}" id="q${question.id}_0" value="0" required>
                                        <label class="form-check-label" for="q${question.id}_0">전혀 그렇지 않다</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="q${question.id}" id="q${question.id}_1" value="1">
                                        <label class="form-check-label" for="q${question.id}_1">가끔 그렇다</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="q${question.id}" id="q${question.id}_2" value="2">
                                        <label class="form-check-label" for="q${question.id}_2">자주 그렇다</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="q${question.id}" id="q${question.id}_3" value="3">
                                        <label class="form-check-label" for="q${question.id}_3">매우 자주 그렇다</label>
                                    </div>
                                </div>
                            </div>
                            `;
                        questionNumber++;
                    });
                    slideContent += `</div>`;
                    slide.innerHTML = slideContent;
                    carousel.appendChild(slide);
                    pageCount++;
                });

                document.getElementById('totalPages').textContent = pageCount;
                updateCurrentPage();
            });

        const carouselElement = document.getElementById('questionCarousel');
        const carousel = new bootstrap.Carousel(carouselElement, {
            interval: false
        });

        carouselElement.addEventListener('slid.bs.carousel', function() {
            updateCurrentPage();
            updateButtonStates();
        });

        function updateCurrentPage() {
            const activeSlide = document.querySelector('.carousel-item.active');
            const currentPage = Array.from(activeSlide.parentNode.children).indexOf(activeSlide);
            document.getElementById('currentPage').textContent = currentPage;
        }

        function updateButtonStates() {
            const currentPage = parseInt(document.getElementById('currentPage').textContent);
            const totalPages = parseInt(document.getElementById('totalPages').textContent);

            prevButton.style.display = currentPage === 1 ? 'none' : 'block';

            if (currentPage === totalPages) {
                nextButton.removeEventListener('click', handleNextClick);
                nextButton.addEventListener('click', showSubmitModal);
            } else {
                nextButton.removeEventListener('click', showSubmitModal);
                nextButton.addEventListener('click', handleNextClick);
            }
        }

        function handleNextClick(event) {
            event.preventDefault();
            carousel.next();
        }

        function checkCurrentPageAndNavigate() {
            const currentPage = parseInt(document.getElementById('currentPage').textContent);
            const totalPages = parseInt(document.getElementById('totalPages').textContent);

            if (checkCurrentPageAnswered() && currentPage < totalPages) {
                setTimeout(() => carousel.next(), 500); // 0.5초 후 다음 페이지로 이동
            } else if (currentPage === totalPages) {
                checkAllAnswered();
            }
        }

        function checkCurrentPageAnswered() {
            const currentSlide = document.querySelector('.carousel-item.active');
            const totalQuestions = currentSlide.querySelectorAll('.custom-question-card').length;
            const answeredQuestions = currentSlide.querySelectorAll('input[type="radio"]:checked').length;
            return totalQuestions === answeredQuestions;
        }

        function checkAllAnswered() {
            if (checkAllQuestionsAnswered()) {
                showSubmitModal();
            }
        }

        function showSubmitModal() {
            const allAnswered = checkAllQuestionsAnswered();
            if (allAnswered) {
                submitConfirmModal.show();
            } else {
                warningModal.show();
            }
        }


        function checkAllQuestionsAnswered() {
            const questions = document.querySelectorAll('.custom-question-card');
            for (let question of questions) {
                const answered = question.querySelector('input[type="radio"]:checked');
                if (!answered) {
                    return false;
                }
            }
            return true;
        }

        nextButton.addEventListener('click', function(event) {
            const currentPage = parseInt(document.getElementById('currentPage').textContent);
            const totalPages = parseInt(document.getElementById('totalPages').textContent);

            if (currentPage === totalPages) {
                event.preventDefault();
                showSubmitModal();
            }
        });
    });
</script>
</body>
</html>
